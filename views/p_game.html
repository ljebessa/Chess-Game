<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>private game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <meta name="google-signin-client_id" content="1032027183995-9ejqlmjsu33kjhhh1rdhcl085kklrlrc.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="moves.js"></script>
    <script src="js/chessboard-0.3.0.js"></script>
    <script src="js/chessboard-0.3.0.min.js"></script>
    <link href="p_game.css" rel="stylesheet">
    <link href="css/chessboard-0.3.0.css" rel="stylesheet">
    <link href="css/chessboard-0.3.0.min.css" rel="stylesheet">
    <!--used for chat box-->
    <script src="https://unpkg.com/cookie_js@1.2.2/cookie.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
</head>

<body>
    <!-- Navigation var-->
    <div class="container">
        <nav class="navbar nav-border navbar-inverse navbar-static-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                                     
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>                        
            </button>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Private Game</a></li>
                        <li><a href="index.html">Login</a></li>
                        <li><a href="lobby.html">Lobby</a></li>
                        <li><a href="b_Players.html">Best Players</a></li>
                        <li><a href="rules.html">Rules</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="index.html" onclick="signOut();"><span class="glyphicon glyphicon-log-in"></span> Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
    <div id="content">
        <div id="nav" class="tab"></div>
        <div id="board" class="tab">
            <p>Status: <span id="status"></span></p>
            <p>FEN: <span id="fen"></span></p>
            <p>PGN: <span id="pgn"></span></p>
        </div>
        <div id="map" class="tab">
            <div class="table-header">
                <h4> Game Moves</h4>
            </div>
            <section class="moves">
                <p id="moves"></p>
            </section>
            <header>
                <div class="chat-header">
                    <div class="table-header">
                        <h4> chat</h4>
                    </div>
                </div>
            </header>

            <section class="chat">

            </section>

            <form>
                <input type="text" placeholder="be respecful when you chat" />
                <button>Send</button>
            </form>
        </div>
        <div id="utils" class="tab">

        </div>
    </div>

    <script>
        window.addEventListener("load", myInit, true);

        function myInit() {
            moves()
        };
    </script>

    <script>
        var room = 'default';
        var socket = io.connect('http://54.149.192.92:3000/private');

        socket.on('connect', function() {
            socket.emit('room', room)
        })
        var game_id = cookie.get('game_id');
        var players = cookie.get('user');
        var player
        var url = "http://localhost:3000/players";
        var params = "game_id=" + game_id;
        var request = new XMLHttpRequest();
        request.open('GET', url + "?" + params, false); // `false` makes the request synchronous
        request.send(null);
        if (request.status === 200) {
            player = JSON.parse(request.responseText);
        }
        var player1 = player[0].player_1;
        var player2 = player[0].player_2;

        var board,
            game = new Chess();

        var removeGreySquares = function() {
            $('#board .square-55d63').css('background', '');
        };

        var greySquare = function(square) {
            var squareEl = $('#board .square-' + square);

            var background = '#a9a9a9';
            if (squareEl.hasClass('black-3c85d') === true) {
                background = '#696969';
            }

            squareEl.css('background', background);
        };

        var onDragStart = function(source, piece, position, orientation) {
            if ((orientation === 'white' && game.turn() === 'b' && piece.search(/^b/) !== -1) ||
                (orientation === 'white' && game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (orientation === 'black' && game.turn() === 'w' && piece.search(/^w/) !== -1) ||
                (orientation === 'black' && game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        };

        socket.on('move', function(msg) {
            game.move(msg);
            board.position(game.fen()); // fen is the board layout
            moves(msg);
        });

        var onDrop = function(source, target) {
            removeGreySquares();

            // see if the move is legal
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: always promote to a queen for example simplicity
            });

            // illegal move
            if (move === null) return 'snapback';
        };

        var handleMove = function(source, target) {
            var move = game.move({
                from: source,
                to: target
            })
            socket.emit('move', move);
        }
        var onMouseoverSquare = function(square, piece) {
            // get list of possible moves for this square
            var moves = game.moves({
                square: square,
                verbose: true
            });

            // exit if there are no moves available for this square
            if (moves.length === 0) return;

            // highlight the square they moused over
            greySquare(square);

            // highlight the possible squares for this piece
            for (var i = 0; i < moves.length; i++) {
                greySquare(moves[i].to);
            }
        };

        var onMouseoutSquare = function(square, piece) {
            removeGreySquares();
        };

        var onSnapEnd = function() {
            board.position(game.fen());
            console.log(game.fen());
        };

        var cfg = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: handleMove,
            onMouseoutSquare: onMouseoutSquare,
            onMouseoverSquare: onMouseoverSquare,
            onSnapEnd: onSnapEnd
        };
        board = ChessBoard('board', cfg);
        if (players === player2) {
            board.orientation('black');
        }
        $(window).resize(board.resize);

        socket.on('message', function(data) {
            $('.chat').append('<p><strong>' + data.user + '</strong>: ' + data.message + '</p>');
            $(".chat").stop().animate({
                scrollTop: $(".chat")[0].scrollHeight
            }, 1000);
        });

        // When the form is submitted
        $('form').submit(function(e) {
            // Avoid submitting it through HTTP
            e.preventDefault();

            // Retrieve the message from the user
            var message = $(e.target).find('input').val();

            // Send the message to the server
            socket.emit('message', {
                user: cookie.get('user') || 'Anonymous',
                message: message
            });

            // Clear the input and focus it for a new message
            e.target.reset();
            $(e.target).find('input').focus();
        });

        //validate user for signout
        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function() {
                console.log('User signed out.');
                cookie.set('user', "");
                window.location.href = "index.html";
            });
        }

        function onLoad() {
            console.log('I am here');
            gapi.load('auth2', function() {
                gapi.auth2.init();
                console.log('User signed in.');

            });
        }

        window.addEventListener("load", myInit, true);

        function myInit() {
            onLoad()
        };
    </script>
</body>

</html>